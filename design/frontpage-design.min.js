/*!
 build: 23-02-2014 20:58, Dmitry Shvalyov, dmitry@shvalyov.ru */
!function(a,b){"use strict";var c="//api.vk.com/method/groups.getMembers",d="yo_photo",e=50,f=0,g=[{name:"Эларджи",url:"#",table:"Грузинская кухня",min_price:1e3},{name:"Оливковый пляж",url:"#",table:"Европейская кухня",min_price:1e3},{name:"Dandy Cafe",url:"#",table:"Европейская кухня",min_price:1e3}],h={amount:3,time:"19:00",now:b()},i={classes:{face:"calendar__face",label:"calendar__label",date:"calendar__date",day:"calendar__day",time:"calendar__time",radio:"calendar__radio",change:"button button_change",calendar:"calendar__container"},calendar:{lang:"ru",sundayFirst:!1,years:1,format:"DD.MM.YYYY"},init:function(){var a=this;a.append(i.buildCalendarList.apply(h))},templateCalendar:function(){var c=b().add("d",this),d={label:a("<label>",{"class":i.classes.label}),face:a("<div>",{"class":i.classes.face}),date:a("<div>",{"class":i.classes.date}).text(c.format("D MMMM")).data("currentdate",c.format(i.calendar.format)),day:a("<span>",{"class":i.classes.day}).text(c.format("dddd")),time:a("<span>",{"class":i.classes.time}).text(h.time),radio:a("<input>",{"class":i.classes.radio,type:"radio",name:"calendars"}),change:a("<button>",{"class":i.classes.change,type:"button"}).text("Изменить"),calendar:a("<div>",{"class":i.classes.calendar})};return i.setCalendarAction.apply(d),d.label.append(d.radio,d.face.append(d.date,d.day,d.time,d.change))},buildCalendarList:function(){for(var a=[],b=this,c=0;c<b.amount;c++)a.push(i.templateCalendar.apply(c));return a},setCalendarAction:function(){var c=this;c.change.on("click",function(d){var e=c.calendar.appendTo(c.face);e.on("mousedown",function(a){a.stopPropagation()}),a(window).on("mousedown",function(){e.remove(),a(window).off("mousedown")}),i.calendar.startDate=c.date.data("currentdate"),i.calendar.onClick=function(d){var f=b(d,i.calendar.format);!0===f.isValid()&&(c.date.data("currentdate",d).text(f.format("D MMMM")),c.day.text(f.format("dddd"))),e.remove(),a(window).off("mousedown")},e.ionCalendar(i.calendar),d.preventDefault(),d.stopPropagation()})}},j={classes:{face:"restaurant__face",label:"restaurant__label",title:"link restaurant__title",table:"restaurant__table",price:"restaurant__price",unit:"restaurant__unit",radio:"restaurant__radio",change:"button button_change"},init:function(){var a=this;a.append(j.buildRestaurantList.apply(g))},templateRestaurant:function(){var b=this,c={label:a("<label>",{"class":j.classes.label}),face:a("<div>",{"class":j.classes.face}),title:a("<span>",{"class":j.classes.title}).text(b.name),table:a("<div>",{"class":j.classes.table}).text(b.table),price:a("<div>",{"class":j.classes.price}).text(b.min_price),unit:a("<div>",{"class":j.classes.unit}).text("на человека"),radio:a("<input>",{"class":j.classes.radio,type:"radio",name:"restaurants"}),change:a("<button>",{"class":j.classes.change,type:"button"}).text("Изменить")};return j.setRestaurantAction.apply(c),c.label.append(c.radio,c.face.append(c.title,c.table,c.price,c.unit,c.change))},buildRestaurantList:function(){var a=[],b=this;for(var c in b)a.push(j.templateRestaurant.apply(b[c]));return a},setRestaurantAction:function(){var a=this;a.change.on("click",function(b){l.init.apply(a.price,[this]),b.preventDefault()})}},k={classes:{face:"classmates__item",icon:"classmates__icon",label:"classmates__label",caption:"classmates__caption",result:"classmates__result",active:"_active",focus:"_focus",hover:"_hover",error:"_error",loading:"_loading"},init:function(){var b=this;b.addClass(k.classes.result+k.classes.loading),k.getUsersList.apply(function(){var c=this;c.error?b.text(c.error.error_msg).addClass(k.classes.result+k.classes.error):c.response&&(b.append(k.buildUsersList.apply(c.response.items)).removeClass(k.classes.result+k.classes.loading),c.response.count<=f*e&&a(".classmates__more").remove())})},templateUser:function(){var b=this,c=b.first_name+" "+b.last_name,d={face:a("<a>",{"class":k.classes.face,title:c}).data("id",b.id),icon:a("<img>",{"class":k.classes.icon,src:b.photo_50}),label:a("<span>",{"class":k.classes.label}),caption:a("<span>",{"class":k.classes.caption}).text(c)};return k.setUserActions.apply(d),d.face.append(d.icon,d.label.append(d.caption))},buildUsersList:function(){var a=[],b=this;for(var c in b)a.push(k.templateUser.apply(b[c]));return a},setUserActions:function(){var b=this;b.face.on("click",function(b){a(this).toggleClass(k.classes.face+k.classes.active),b.preventDefault()}),b.face.on("mouseenter touchenter",function(){a(this).addClass(k.classes.face+k.classes.hover)}),b.face.on("mouseleave touchleave",function(){a(this).removeClass(k.classes.face+k.classes.hover)})},getUsersList:function(){var b=this;a.ajax({url:c,data:{group_id:d,offset:f*e,fields:"photo_50",count:e,v:5.11}}).done(function(a){b.apply(a)})}},l={wait:null,init:function(b){var c=this,d=a(b),e=a("<div>",{"class":"editinplace__wrapper"}),f=a("<input>",{"class":"editinplace__input",type:"text",pattern:"[0-9]{4,5}",placeholder:"желаемая цена",title:"Без единицы измерения"});if(c.wrap(e),c.hide().parent().append(f),f.focus(),f.on("blur",function(){l.wait=setTimeout(function(){d.trigger("click",!1)},120)}),f.on("keydown",function(a){13===a.keyCode?d.trigger("click",!0):27===a.keyCode&&d.trigger("click",!1)}),"undefined"!=typeof a._data(b,"events").click){var g=a._data(b,"events").click[0].handler;d.off("click"),d.on("click",function(a,b){l.submit.apply(c,[f,!1===b?!1:!0]),d.off("click"),d.on("click",g)})}},submit:function(b,c){var d=a(this),e=b.val();!0===c&&d.text(l.validate.apply(e)||d.text()),!0===d.parent().hasClass("editinplace__wrapper")&&(d.parent().replaceWith(d),clearTimeout(l.wait)),d.show(),a(b).remove()},validate:function(){return a.trim(this.replace(/[^\0-9]/gi,""))}};a(function(){var b=a(".classmates-list"),c=a(".classmates__result"),d=a("<a>",{"class":"link link_local classmates__more"}).text("Показать еще "+e+" человек");a.ajaxSetup({type:"GET",async:!1,cache:!0,contentType:"application/json",dataType:"jsonp"}),c.empty(),d.on("click",function(a){k.init.apply(c),f++,a.preventDefault()}).trigger("click"),b.append(d);var g=a(".calendars-list");g.length&&i.init.apply(g);var h=a(".restaurants-list");h.length&&j.init.apply(h)})}(window.jQuery,window.moment);